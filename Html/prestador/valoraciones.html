<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valoraciones - JobXpress</title>

  <link rel="stylesheet" th:href="@{/css/stylevaloraciones.css}">
</head>

<body>

<header class="navbar">
  <div class="logo">JobXpress</div>

  <nav class="nav-links">
      <a th:href="@{/prestador/home}">Inicio</a>
      <a th:href="@{/prestador/servicioPrestador}">Tu servicio</a>
      <a th:href="@{/prestador/perfil}">Tu Perfil</a>
      <a th:href="@{/prestador/ganancias}">Tus ganancias</a>
      <a th:href="@{/prestador/valoraciones}" class="activo">Tus valoraciones</a>
      <a th:href="@{/prestador/agenda}">Mi agenda</a>
      <a th:href="@{/prestador/dashboard}">Dashboard</a>

      <!-- Cerrar sesi√≥n -->
      <a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
          Cerrar sesi√≥n
      </a>
      <form id="logout-form" th:action="@{/logout}" method="POST" style="display:none;"></form>
  </nav>
</header>

<main class="contenedor-principal">
  
  <section class="tarjeta-valoraciones">
    <h1>‚≠ê Tus Valoraciones</h1>
    <p class="texto-promedio">Tienes una valoraci√≥n promedio de:</p>

    <div class="valoracion-promedio">
      <span class="estrellas grandes">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <p class="promedio-num" id="promedioValor">0 / 5</p>
    </div>

    <p class="detalle">
      Has completado <strong id="totalServicios">0</strong> servicios y recibido 
      <strong id="totalResenas">0</strong> rese√±as.
    </p>

    <div class="bloque-resenas" id="resumenEstrellas"></div>

  </section>

  <!-- COMENTARIOS -->
  <section class="seccion-comentarios">
    <h2>üí¨ √öltimos Comentarios</h2>

    <div class="contenedor-comentarios" id="listaComentarios">

      <!-- SE RELLENA CON JS -->

    </div>

  </section>
</main>


<!-- ============================= -->
<!--   SCRIPT PARA MOSTRAR DATOS   -->
<!-- ============================= -->
<script>
  // Obtener comentarios desde localStorage
  let valoraciones = JSON.parse(localStorage.getItem("valoracionesPrestador")) || [];

  const contComentarios = document.getElementById("listaComentarios");
  const promedioValor = document.getElementById("promedioValor");
  const totalServicios = document.getElementById("totalServicios");
  const totalResenas = document.getElementById("totalResenas");
  const resumenEstrellas = document.getElementById("resumenEstrellas");

  // Si no hay valoraciones
  if (valoraciones.length === 0) {
      contComentarios.innerHTML = `
          <p style="padding:10px; opacity:0.7;">A√∫n no tienes comentarios.</p>
      `;
  } else {

      // Mostrar comentarios
      valoraciones.forEach(c => {
          contComentarios.innerHTML += `
            <div class="comentario">
              <div class="avatar"><span>${c.cliente.charAt(0)}</span></div>

              <div class="texto">
                <div class="nombre-fecha">
                  <strong>${c.cliente}</strong>
                  <span class="fecha">${c.fecha}</span>
                </div>

                <div class="estrellas">
                  ${"‚òÖ".repeat(c.estrellas)}${"‚òÜ".repeat(5 - c.estrellas)}
                </div>

                <p>${c.comentario}</p>
              </div>
            </div>
          `;
      });

      // CALCULAR PROMEDIO
      let total = valoraciones.length;
      let suma = valoraciones.reduce((acc, v) => acc + v.estrellas, 0);
      let promedio = (suma / total).toFixed(1);

      promedioValor.innerText = `${promedio} / 5`;
      totalResenas.innerText = total;

      // Cantidad por estrella
      let conteo = [0,0,0,0,0]; // 1 a 5
      valoraciones.forEach(v => conteo[v.estrellas - 1]++);

      // Mostrar resumen
      resumenEstrellas.innerHTML = "";
      for (let i = 5; i >= 1; i--) {
          let cantidad = conteo[i - 1];
          let porcentaje = (cantidad / total) * 100;

          resumenEstrellas.innerHTML += `
            <div class="fila">
              <span class="nivel">${i}‚òÖ</span>
              <div class="barra">
                <div class="relleno" style="width:${porcentaje}%;"></div>
              </div>
              <span class="cantidad">${cantidad}</span>
            </div>
          `;
      }

      // Contador de servicios completados si los tienes guardados
      totalServicios.innerText = localStorage.getItem("serviciosCompletados") || valoraciones.length;
  }
</script>

</body>
</html>